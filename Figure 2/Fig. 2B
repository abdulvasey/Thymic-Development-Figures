library(tidyverse)
library(Seurat)
library(pheatmap)
library(cowplot)
library (dendsort)
library(ggdendro)
sort_hclust <- function(...) as.hclust(dendsort::dendsort(as.dendrogram(...)))

srt <- readRDS("all_red.epi.from.individual.overall.int.rds")
barcode_key <- read_csv("horizontal_metadata.csv")


srt@meta.data <- srt@meta.data %>% 
  # select(-tissue, -annotation_2, -annotation_1, cell_name) %>%
  rownames_to_column("barcode") %>% 
  left_join(barcode_key %>% select(barcode, tissue, annotation_2=cellType,annotation_1=cellGroup), by = "barcode") %>%
  mutate(tissue = case_when(
    tissue == "tec" ~ "Thymus",
    tissue == "bec" ~ "Bronchus",
    tissue == "lec" ~ "Lung",
    tissue == "eec" ~ "Esophagus"
  )) %>% 
  unite("cell_name", annotation_2, tissue, sep = "-",remove = F) %>% 
  column_to_rownames("barcode")

# Average expression across annotated clusters
srt_avg <- AverageExpression(srt, assays = "RNA", group.by = "cell_name", return.seurat = T)
# Remove NA cluster created from cells that didn't fall in an annotation group
srt_avg <- srt_avg[,!grepl("NA", colnames(srt_avg))] 
# Reprocess data
srt_avg <- NormalizeData(srt_avg)
srt_avg <- FindVariableFeatures(srt_avg, selection.method = "vst", nfeatures = 2000)
all.genes <- rownames(srt_avg)
srt_avg <- ScaleData(srt_avg, features = all.genes)
srt_avg <- RunPCA(srt_avg, features = VariableFeatures(object = srt_avg), npcs = 20)

Idents(srt_avg) <- colnames(srt_avg)
include_clusters <- c(
  "cTEC-Thymus",
  "mcTEC-Thymus",
  "mTECI-Thymus",
  "Epithelial_Basal-Esophagus",
  "Suprabasal-Esophagus",
  "Multiciliated-Esophagus",
  "Epithelial_Basal-Bronchus",
  "Club-Bronchus",
  "Bud Tip Progenitor-Lung",
  "Bud Tip Progenitor Adjacent-Lung",
  "Secretory-Bronchus",
  "Goblet-Bronchus",
  "Submucosal Gland-Bronchus",
  "Multiciliated-Bronchus"
)
srt_avg_sub <- subset(srt_avg, idents = include_clusters)


embeddings <- srt_avg_sub@reductions$pca@cell.embeddings
hc_corr <- hclust(as.dist(1-cor(t(as.matrix(embeddings)))))
annotation_df <- tibble(group = sort_hclust(hc_corr)$labels[sort_hclust(hc_corr)$order]) %>% 
  separate(group, into = c(NA, "Tissue"), sep = "-", remove = F) %>% 
  left_join(
    tibble(Tissue = c("Bronchus", "Esophagus", "Thymus", "Lung"),
           color = RColorBrewer::brewer.pal(4, "Set1")),
    by = "Tissue"
  ) %>% 
  column_to_rownames("group")
cor_mat <- cor(t(as.matrix(embeddings)))
plt_ec<-pheatmap::pheatmap(cor_mat,
                   cluster_cols = sort_hclust(hc_corr),
                   cluster_rows = sort_hclust(hc_corr),
                   color = viridis::viridis(40),
                   annotation_col = annotation_df %>% select(Tissue),
                   annotation_row = annotation_df %>% select(Tissue),
                   annotation_colors = list(Tissue = annotation_df %>% select(Tissue, color) %>% distinct() %>% deframe()))

plt_ec$tree_row$labels[plt_ec$tree_row$order]

plot(plt_ec$tree_row, labels = F, hang = -1)
plt_tree <- ggdendro::ggdendrogram(plt_ec$tree_col) + theme_void()
group=c('Multiciliated B', 'Multiciliated E', 'BTP Adjacent L', 'Secretory B', 'BTP L', 'Club B', 'Epithelial Basal B', 'Goblet B', 'Submucosal Gland B', 'Epithelial Basal E','Suprabasal E', 'cTEC T', 'mcTEC T', 'mTECI T')
plt_htmp <- as.data.frame(cor_mat) %>% 
  rownames_to_column("rows") %>% 
  pivot_longer(-rows, names_to = "cols", values_to = "cor") %>% 
  mutate_if(is.character, ~factor(.,levels = plt_ec$tree_row$labels[plt_ec$tree_row$order])) %>% 
  ggplot(aes(x = rows, y = cols, fill = cor)) + 
  geom_tile(color = "white") + 
  theme_minimal() +
  scale_fill_viridis_c(option = "mako") +
  #scale_fill_viridis(option = "E") +
  #scale_colour_brewer(palette = "Greens") +
  #scale_fill_gradient(low = "black",high = "white") +
  #scale_fill_gradient2(low = "grey99", mid = "pink", high = "orchid") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1,color='black'),axis.text.y = element_text(color='black'),text = element_text(size = 18,color='black')) +
  scale_x_discrete(labels=group)+scale_y_discrete(labels=group)+
  labs(x="", y = "", fill = "Correlation")
plt_htmp

plt_key <- as.data.frame(cor_mat) %>% 
  rownames_to_column("rows") %>% 
  select(rows) %>% 
  mutate(rows = factor(rows, levels = plt_ec$tree_row$labels[plt_ec$tree_row$order])) %>% 
  separate(rows, into = c(NA, "Tissue"), sep = "-", remove = F) %>% 
  ggplot(aes(x = rows, y = 1, fill = Tissue)) + 
  geom_tile(color = "black")+
  theme_void() + 
  scale_fill_manual(values = c("#7570B3","#E7298A","#1B9E77","#D95F02")) +
  #scale_fill_manual(values = c("#1C8F64","#CE4A09","#6259A4","#DE0077")) +
  labs(x="",y="") +
  theme (text = element_text(size = 15))
plt_key

lgd_htmp <- get_legend(plt_htmp+ theme(legend.justification = c(0,1)))
lgd_key <- get_legend(plt_key+ theme(legend.justification = c(0,1)))
plt_htmp_grid <- cowplot::plot_grid(
  plt_tree,
  plt_key + theme(legend.position = "none"),
  plt_htmp + theme(legend.position = "none"),
  ncol = 1,
  rel_heights = c(0.1,0.02,0.9),
  axis = "lr",
  align = "v"
)
plt_lgd <- cowplot::plot_grid(
  NULL,
  lgd_key,
  lgd_htmp,
  NULL,
  ncol = 1,
  rel_heights = c(0.1,0.3,0.3,0.4)
)
plt_full_htmp <- cowplot::plot_grid(
  plt_htmp_grid,
  plt_lgd,
  nrow = 1,
  rel_widths = c(0.8,0.2)
)
plt_full_htmp
